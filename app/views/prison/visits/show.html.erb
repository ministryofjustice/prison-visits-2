<%= render 'prison/dashboards/banner' %>

<% if current_user %>
  <%= render 'prison/dashboards/navigation' %>
<% end %>

<div class="grid-row">
  <div class="column-one-third">
    <h1 class="bold-large float-left"><%= t('.title') %></h1>
    <span class="tag tag--heading tag--<%= @visit.processing_state %> font-xsmall float-left"><%= @visit.processing_state.capitalize %></span>
  </div>
  <div class="column-two-thirds">
    <div class="grid-row">
      <div class="column-one-third">
        <div class="text-secondary"><%= t('requested', scope: 'shared') %>: <br><%= @visit.created_at.to_s(:short) %></div>
      </div>
      <div class="column-one-third">
        <div class="text-secondary"><%= @visit.processing_state.capitalize %>: <br><%= @visit.updated_at.to_s(:short) %></div>
      </div>
      <div class="column-one-third">
        <% if @visit.reference_no -%>
          <div class="text-secondary"><%= t('.ref') %>: <br><%= @visit.reference_no %></div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% if @visit.closed? && @visit.booked? %>
  <p class="panel panel-border-narrow font-xsmall">
    <%= t('.closed_visit') %>
  </p>
<% end %>

<div class="grid-row">
  <% if @visit.rejection %>
    <div class="column-two-thirds push-top">
      <div class="panel panel-border-narrow">
        <div class="text-secondary">
          <%= @visit.processing_state.capitalize %> reason
        </div>
        <small class="font-xsmall"><%= t(@visit.rejection_reason, scope: :shared) %></small>
      </div>
    </div>
  <% end %>
  <% if @visit.cancelled? %>
    <div class="column-two-thirds push-top">
      <div class="panel panel-border-narrow">
        <div class="text-secondary">
          <%= @visit.processing_state.capitalize %> reason
        </div>
        <small class="font-xsmall"><%= t(@visit.cancellation_reason, scope: :shared) %></small>
      </div>
    </div>
  <% end %>
</div>

<hr>
<%= render 'prison/visits/prisoner_details', visit: @visit %>

<%= form_tag cancel_prison_visit_path(@visit, locale: 'en'), class: 'form' do -%>

  <%= render 'prison/visits/cancel_prisoner' %>

  <hr>

  <h2 class="bold-medium">Visit date</h2>
  <div class="grid-row push-top date-box--chosen">
    <% @visit.slots.each_with_index do |slot, i| %>
    <div class="column-one-third">
      <div class="block-label date-box <%= 'selected' if @visit.slot_granted == slot %>">
        <span class="date-box__number"><%= (i+1).ordinalize %></span>
        <span class="date-box__day"><%= format_date_day(slot) %></span>
        <br><%= format_date_of_birth(slot) %> <br><%= format_slot_times(slot) %>
      </div>
    </div>
    <% end %>
  </div>
  <%= render 'prison/visits/cancel_date' %>

  <hr>

  <h2 class="bold-medium push-bottom"><%= t('visitors', scope: :shared) %></h2>
  <div class="visitor-labels">
    <div class="grid-row">
      <% @visit.visitors.each_with_index do |visitor, index| %>
        <%= render 'prison/visits/visitor_detail', visitor: visitor, index: index %>
      <% end %>
    </div>
  </div>
  <%= render 'prison/visits/cancel_visitor' %>

<% end %> <!-- end form tag -->
<hr>

<div class="grid-row">
  <div class="column-two-thirds">
    <h3 class="bold-medium push-bottom" id="messages"><%= t('.messages') %></h3>
    <% if current_user %>
      <% if @visit.booked? %>
        <div class="panel panel-border-narrow">
          <h3 class="bold-medium"><%= t('.send_a_message') %></h3>
          <%= form_for [:prison, @visit, @message], html: { class: 'js-SubmitOnce  form' } do |f| -%>
            <%= single_field(f, :body, :text_area, class: 'form-control form-control-full-width', rows: 4) %>
            <div class="">
              <%= f.submit t('.send_email'), class: 'button' %>
            </div>
          <% end -%>
        </div>
      <% else -%>
        <div class="panel panel-border-narrow"><%= t('.message_not_allowed') %></div>
      <% end -%>
    <% end %>
    <% if @visit.messages.any? -%>
      <% @visit.messages.each do |message| %>
        <div class='messages push-top'>
          <div class="message">
            <div class="message-top">
              <span class="bold-small"><%= message.user.email %></span>
              <span class="dash">â€”</span>
              <span class="datetime"><%= time_ago_in_words(message.created_at) %></span>
            </div>
            <p class="message-content"><%= message.body %></p>
          </div>
        </div>
      <% end %>
    <% else %>
      <p><%= t('.no_messages') %></p>
    <% end -%>
  </div>

  <div class="column-one-third">
    <h3 class="bold-medium push-bottom"><%= t('.visit_history') %></h3>
    <%= render 'prison/visits/timeline' %>
  </div>
</div>
