jobs:
  test:
    parallelism: 1
    working_directory: ~/prison-visits-2
    docker:
      - image: circleci/ruby:latest-node-browsers
        environment:
          RAILS_ENV: test
          PG_HOST: localhost
          PG_USER: ubuntu
          RAILS_ENV: test
          RACK_ENV: test
      - image: circleci/postgres:9.4.12-alpine
        environment:
          POSTGRES_USER: ubuntu
          POSTGRES_DB: prison-visits-2_test
    steps:
      - checkout

      # Restore bundle cache
      - restore_cache:
          key: rails-demo-{{ checksum "Gemfile.lock" }}

      # Bundle install dependencies
      - run: bundle install --path vendor/bundle

      # Store bundle cache
      - save_cache:
          key: rails-demo-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - type: shell
        command: |

          wget https://github.com/mozilla/geckodriver/releases/download/v0.19.0/geckodriver-v0.19.0-linux64.tar.gz
          tar -zxvf geckodriver-v0.19.0-linux64.tar.gz
          sudo mv geckodriver /usr/local/bin/


      # Database setup
      - run: bundle exec rake db:create
      - run: bundle exec rake db:schema:load

      # Run rspec in parallel
      - type: shell
        command: |
          sudo Xvfb :7055 &
          bundle exec rspec $(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings)

      # Save test results for timing analysis
      - store_test_results:
          path: coverage
  build:
    working_directory: ~/prison-visits-2
    docker:
      - image: docker:17.05.0-ce-git
    steps:
      - checkout
      - setup_remote_docker
     - run:
          name: Push application Docker image
          command: |
            docker tag app "prison-visits-2:${CIRCLE_SHA1}"
            docker push "prison-visits-2:${CIRCLE_SHA1}"

workflows:
  version: 2
  test-and-build:
    jobs:
      - test
      - build:
          requires: test
